import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
from matplotlib import rcParams
import warnings

# warning'ler
warnings.filterwarnings("ignore")

# seaborn default set işlemi
sns.set()

# notebook için 'png' set işlemi
%config InlineBackend.figure_format = 'png' 
%matplotlib inline

# data setlerin yolları
trainData = 'data/train.csv'
testData = 'data/test.csv'

# data setleri import edelim
train = pd.read_csv(trainData, header=0)
test = pd.read_csv(testData, header=0)




train.head()



# bütün datayı birleştirelim (Id ve SalePrice sütunlarını almadan)
all_data = pd.concat((train.loc[:,'MSSubClass':'SaleCondition'], 
                      test.loc[:,'MSSubClass':'SaleCondition']))
                      
                      
                      
 all_data.head()
 
 
 
 train['GrLivArea'].describe()
 
 
 
 # figure'un şekli
rcParams['figure.figsize'] = (6.0, 6.0) 

# seaborn ile görselleştirme
sns.scatterplot(x='GrLivArea', y='SalePrice', data=train)

plt.show()


# outlier atmadan önce şekil

train.shape



# şimdi outlier'ları atalım

train = train.drop(train[(train['GrLivArea']>3200)].index).reset_index(drop=True)


# outlier attıktan sonra şekil

train.shape




# outlier atılmış hali ile test datayı birleştirelim

all_data = pd.concat((train.loc[:,'MSSubClass':'SaleCondition'], test.loc[:,'MSSubClass':'SaleCondition']))



all_data.head()



all_data['YrSold']



# tür dönüşümü yapalım

all_data['MSSubClass'] = all_data['MSSubClass'].apply(str)
all_data['OverallCond'] = all_data['OverallCond'].astype(str)
all_data['YrSold'] = all_data['YrSold'].astype(str)
all_data['MoSold'] = all_data['MoSold'].astype(str)



from sklearn.preprocessing import LabelEncoder



# encode edilecek sütunlar

cols = ('FireplaceQu', 'BsmtQual', 'BsmtCond', 'GarageQual', 'GarageCond', 
        'ExterQual', 'ExterCond','HeatingQC', 'PoolQC', 'KitchenQual', 'BsmtFinType1', 
        'BsmtFinType2', 'Functional', 'Fence', 'BsmtExposure', 'GarageFinish', 'LandSlope',
        'LotShape', 'PavedDrive', 'Street', 'Alley', 'CentralAir', 'MSSubClass', 'OverallCond', 
        'YrSold', 'MoSold')
        
        
        
# döngü ile bütün sütunları encode et

for c in cols:
    lbl = LabelEncoder() 
    lbl.fit(list(all_data[c].values)) 
    all_data[c] = lbl.transform(list(all_data[c].values))
    
    
# bütun sütunları görelim

all_data.columns




# OneHotEncoder öncesi datanın şekli

all_data.shape




# şimdi one hot encoder yapabiliriz -> get_dummies()

all_data = pd.get_dummies(all_data)




# OneHotEncoder sonrası datanın şekli

all_data.shape



# yeni sütunları görelim

all_data.columns


# scipy'in skew fonksiyonu bize skew yani kuyruk değerini verir
from scipy.stats import skew

# "SalePrice" için histogram

rcParams['figure.figsize'] = (12.0, 6.0) # şeklin boyutu

g = sns.distplot(train["SalePrice"], label="Skewness: %.2f"%(train["SalePrice"].skew()))

g = g.legend(loc="best")

plt.show()




normalizedSalePrice = np.log1p(train["SalePrice"])

# "SalePrice" için histogram

rcParams['figure.figsize'] = (12.0, 6.0) # şeklin boyutu

g = sns.distplot(normalizedSalePrice, label="Skewness: %.2f"%(train["SalePrice"].skew()))

g = g.legend(loc="best")

plt.show()



train["SalePrice"] = np.log1p(train["SalePrice"])


# eksik veri var mı

all_data.isnull().any().any()



# NA olan değerleri mean ile dolduralım

all_data = all_data.fillna(all_data.mean())



# eksik veri var mı

all_data.isnull().any().any()


# sklearn için matrisleri yaratlım

X_train = all_data[:train.shape[0]]

X_test = all_data[train.shape[0]:]

y = train.SalePrice



X_train.head()




X_train.shape




from sklearn.model_selection import cross_val_score



# k-fold cross validation kullanarak RMSE hesapla

def rmse_cv(model, cv=5):
    rmse = np.sqrt(-cross_val_score(model, X_train, y, scoring='neg_mean_squared_error', cv=cv))
    return rmse
    
    
from sklearn.linear_model import LinearRegression

# lineer modeli yarat
linearModel = LinearRegression()

# rmse için fonksiyon çağır
rmse = rmse_cv(linearModel)

# sonucu yazdır
print("RMSE Ortalaması: {}, std: {}".format(rmse.mean(), rmse.std()))




# fit linear model
linearModel.fit(X_train, y)



# katsayılar

weights = linearModel.coef_

print(weights)



weights.shape


# en büyük değerli katsayıları alalım (mutlak değer)

coef = pd.Series(weights, index = X_train.columns)

# ilk 10 ve son 10 büyük katsayıyı alalım (important coefficients)
imp_coef = pd.concat([coef.sort_values().head(10), coef.sort_values().tail(10)])


# şimdi bu katsayıları görelim

imp_coef.plot(kind = "barh")

plt.title("En Büyük Değerli Katsayılar")

plt.show()



from sklearn.linear_model import Ridge



# alpha = 0.1 ile ridge regression modeli çalıştırıp RMSE hesaplayalım
ridgeModel = Ridge(alpha = 0.1)

# cross validation ile RMSE alalım
rmse = rmse_cv(ridgeModel)

print("RMSE Ortalaması: {}, std: {}".format(rmse.mean(), rmse.std()))



# fit linear model
ridgeModel.fit(X_train, y)



# en büyük değerli katsayıları alalım (mutlak değer)

coef_ridge = pd.Series(ridgeModel.coef_, index = X_train.columns)

# ilk 10 ve son 10 büyük katsayıyı alalım (important coefficients)
imp_coef_ridge = pd.concat([coef_ridge.sort_values().head(10), coef_ridge.sort_values().tail(10)])




# şimdi bu katsayıları görelim

imp_coef_ridge.plot(kind = "barh")

plt.title("En Büyük Değerli Katsayılar")

plt.show()



# farklı alpha değerleri için RMSE hesapla

alphas = [0.05, 0.1, 0.3, 1, 3, 5, 10, 15, 30, 50, 75]

cv_ridge = [rmse_cv(Ridge(alpha = alpha)).mean() for alpha in alphas]

cv_ridge = pd.Series(cv_ridge, index = alphas)

# RMSE vs alpha grafiği
cv_ridge.plot(title = "Alpha Değişimi & Ridge Regression RMSE Değeri")

plt.xlabel("alpha")
plt.ylabel("rmse")

plt.show()




optimalRidgeAlpha = cv_ridge[cv_ridge == cv_ridge.min()].index.values[0]

print("Optimal Ridge Alpha Değeri: {}".format(optimalRidgeAlpha))



# optimal alpha ile ridge regression modelin RMSE değerini bulalım
ridgeModel = Ridge(alpha = optimalRidgeAlpha)

rmse = rmse_cv(ridgeModel)

print("RMSE Ortalaması: {}, std: {}".format(rmse.mean(), rmse.std()))



# fit linear model
ridgeModel.fit(X_train, y)



# en büyük değerli katsayıları alalım (mutlak değer)

coef_ridge = pd.Series(ridgeModel.coef_, index = X_train.columns)

# ilk 10 ve son 10 büyük katsayıyı alalım (important coefficients)
imp_coef_ridge = pd.concat([coef_ridge.sort_values().head(10), coef_ridge.sort_values().tail(10)])




# şimdi bu katsayıları görelim

imp_coef_ridge.plot(kind = "barh")

plt.title("En Büyük Değerli Katsayılar")

plt.show()



# en büyük değerli katsayılar
ridge_coef = pd.Series(ridgeModel.coef_, index = X_train.columns)
ridge_imp_coef = pd.concat([ridge_coef.sort_values().head(10), ridge_coef.sort_values().tail(10)])

rcParams['figure.figsize'] = (8.0, 10.0) # grafiğin boyutu

df = pd.DataFrame({ "RidgeRegression" : ridge_imp_coef, "LinearRegression" : imp_coef })

df.plot(kind = "barh")
plt.title("En Büyük Değerli Katsayılar Ridge - Lineer Regresyon")

plt.show()




from sklearn.linear_model import Lasso



# determine RMSE for lasso regression model with alpha = 0.1
lassoModel = Lasso(alpha = 0.1)
rmse = rmse_cv(lassoModel)
print("RMSE Ortalaması: {}, std: {}".format(rmse.mean(), rmse.std()))



# Farklı alpha değerleri için RMSE hesapla

alphas = [0.05, 0.1, 0.3, 1, 3, 5, 10, 15, 30, 50, 75]

cv_lasso = [rmse_cv(Lasso(alpha = alpha)).mean() for alpha in alphas]
cv_lasso = pd.Series(cv_lasso, index = alphas)

# grafiğin boyutu
rcParams['figure.figsize'] = (12.0, 6.0)

# plot RMSE vs alpha
cv_lasso.plot(title = "Alpha üzerinden Lasso Regression için RMSE")
plt.xlabel("alpha")
plt.ylabel("rmse")
plt.show()




from sklearn.linear_model import LassoCV

# LassoCV ile en uygun alpha değerini bul
lassoModel = LassoCV(alphas = np.linspace(0.0002, 0.0022, 21), cv = 5).fit(X_train, y)
lassoModel.alpha_

optimalLassoAlpha = lassoModel.alpha_
print("Optimal lasso alpha: {}".format(optimalLassoAlpha))



lassoModel = Lasso(alpha = optimalLassoAlpha)

rmse = rmse_cv(lassoModel)

print("RMSE Ortalaması: {}, std: {}".format(rmse.mean(), rmse.std()))


# fit lasso model
lassoModel.fit(X_train, y)

# en büyük değerli katsayılar
lasso_coef = pd.Series(lassoModel.coef_, index = X_train.columns)
lasso_imp_coef = pd.concat([lasso_coef.sort_values().head(10), lasso_coef.sort_values().tail(10)])

rcParams['figure.figsize'] = (8.0, 10.0)

df = pd.DataFrame({ "LassoRegression" : lasso_imp_coef, "LinearRegression" : imp_coef })

df.plot(kind = "barh")
plt.title("En Büyük Değerli Katsayılar Lasso")
plt.show()




ridge_coef = pd.Series(ridgeModel.coef_, index = X_train.columns)
print('Sıfır Olmayan Katsayı Adedi - Ridge:', sum(ridge_coef != 0))
print('Sıfır Katsayı Adedi - Ridge:', sum(ridge_coef == 0))



lasso_coef = pd.Series(lassoModel.coef_, index = X_train.columns)
print('Sıfır Olmayan Katsayı Adedi - Lasso:', sum(lasso_coef != 0))
print('Sıfır Katsayı Adedi - Lasso:', sum(lasso_coef == 0))



